<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poodl | UK Full Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght(400;600;700)&display=swap" rel="stylesheet">
    <style>
        /* Stili Personalizzati e Colori Poodl */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            padding-top: 60px; /* Space for fixed elements */
        }
        .schedule-card {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }
        /* Gradiente Poodl per il pulsante */
        .poodl-gradient {
            background: linear-gradient(90deg, #1f4287 0%, #a33f52 100%); /* Blue-Violet to Red-Magenta */
            transition: opacity 0.3s ease, transform 0.1s ease;
        }
        .poodl-gradient:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        /* Stile per le singole righe di appuntamento */
        .schedule-item {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
        }
        .schedule-item:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            background-color: #f9f9fb;
        }
        /* Colore per l'ora (custom Poodl color) */
        .time-color {
            color: #5A3FA3;
        }
        
        /* Stile per il language switch icon */
        .lang-switch {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 32px; 
            cursor: pointer;
            transition: transform 0.2s ease;
            text-decoration: none;
            z-index: 10;
        }
        /* New class for the dynamically set flag - changed cursor to default */
        .dynamic-flag {
            cursor: default; 
            left: 20px;
            top: 20px;
            position: fixed;
            font-size: 32px;
            z-index: 10;
        }

        .lang-switch:hover {
            transform: scale(1.1);
        }

        /* Stile per il pulsante di stato Live (fisso in alto a destra) */
        .live-status-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
            white-space: nowrap; /* Prevents text wrap on small screens */
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .live-status-btn {
                right: 50%;
                transform: translateX(50%);
                top: 70px;
            }
            body {
                padding-top: 120px;
            }
        }
    </style>
</head>
<body>

<!-- Dynamic Flag Display based on user's location/TZ (new) -->
<div id="dynamic-flag-display" class="dynamic-flag" title="La tua bandiera locale (rilevata)">üá¨üáß</div>

<!-- Live Status Button (Poodl Gradient) -->
<a href="https://marc-industries.github.io/poodl-meeting" class="live-status-btn poodl-gradient text-white font-bold py-2 px-6 rounded-full transition duration-150 ease-in-out shadow-xl transform hover:scale-105">
    <span class="inline-block w-3 h-3 bg-green-400 rounded-full mr-2 animate-pulse"></span>
    Check Live Status
</a>


<div class="schedule-card">
    
    <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Weekly Zoom Meetings in English üá¨üáß</h1>
    <p class="text-lg text-gray-500 mb-4">üåç Open to Members & their Guests</p>

    <!-- Introductory Content -->
    <div class="mb-8 p-4 bg-blue-50 border-l-4 border-[#1f4287] rounded-lg">
        <p class="text-gray-700 leading-relaxed text-sm">
            Community Members and their guests are warmly invited to join our open Zoom sessions ‚Äî an exciting chance to learn more about this incredible opportunity that‚Äôs inspiring people around the world! ‚ú®
            <br><br>
            üí´ Come discover what‚Äôs possible ‚Äî connect with like-minded people, get inspired, and explore how you can benefit from this unique opportunity.
        </p>
    </div>

    <!-- Contenitore della Programmazione Dinamica -->
    <div id="schedule-container" class="space-y-6">
        <!-- Il programma verr√† iniettato qui dallo script -->
    </div>
    
    <!-- Footer CTA -->
    <div class="mt-8 pt-4 border-t text-center">
        <p class="text-gray-500 italic text-sm">Choose the session that best fits your schedule ‚Äî we can‚Äôt wait to welcome you and your guests! üíñ</p>
    </div>
</div>

<script>
    // --------------------------------------------------------
    // CONFIGURATION: SCHEDULE AND LINKS (UK TIME ZONE)
    // --------------------------------------------------------
    
    // Day: 0=Sun, 1=Mon, ..., 6=Sat
    const SCHEDULE = [
        // Tuesday (2): 7:00 PM
        { day: 2, startHour: 19, startMinute: 0, link: "https://us06web.zoom.us/j/81102996182?pwd=J9kR9aWTwg6SaW31WQp3ojdEOvEY8c.1", description: "Tuesday Evening Call" },
        
        // Wednesday (3): 6:00 PM
        { day: 3, startHour: 18, startMinute: 0, link: "https://us06web.zoom.us/j/85392273248?pwd=aQKUkLqTHgOAswpbM6LxBauNeXdq2R.1", description: "Wednesday Evening Call" },
        
        // Thursday (4): 8:30 AM & 5:00 PM
        { day: 4, startHour: 8, startMinute: 30, link: "https://us06web.zoom.us/j/87317484917?pwd=4RBeb5ylYC3O9aejZhgEvo3NLGZaT4.1", description: "Thursday Morning Call" },
        { day: 4, startHour: 17, startMinute: 0, link: "https://us06web.zoom.us/j/83683918589?pwd=hEVTG7j7OsyoIQAHRMXk7ytcDLkdsR.1", description: "Thursday Afternoon Call" },
        
        // Friday (5): 8:30 AM & 5:00 PM
        { day: 5, startHour: 8, startMinute: 30, link: "https://us06web.zoom.us/j/88030162456?pwd=y9A5cOaDKbNJdpqUxtrMZOmJaVgZf7.1", description: "Friday Morning Call" },
        { day: 5, startHour: 17, startMinute: 0, link: "https://us06web.zoom.us/j/89941028091?pwd=lW7MDxBSbQGIGh6VKlOCKJrRKFeiTL.1", description: "Friday Afternoon Call" },
    ];

    // --------------------------------------------------------
    // HELPER FUNCTIONS FOR FLAG AND TIME ZONE (LOGICA PI√ô PRECISA)
    // --------------------------------------------------------

    // Mappatura fuso orario/acronimo su un codice paese rappresentativo (FALLBACK)
    const TZ_ACRONYM_MAP = {
        'CEST': 'IT', 'CET': 'IT', 
        'PDT': 'US', 'PST': 'US',  
        'EDT': 'US', 'EST': 'US',  
        'BST': 'GB', 'GMT': 'GB', 
        'IST': 'IN', 'AEST': 'AU', 
        'AEDT': 'AU', 'JST': 'JP',  
        'KST': 'KR', 
    };

    // Mappatura IANA Time Zone ID sul codice Paese specifico (PI√ô PRECISA)
    const IANA_TZ_TO_COUNTRY_MAP = {
        // Europe/Middle East (CEST/CET)
        'Europe/Rome': 'IT',
        'Europe/Paris': 'FR',
        'Europe/Berlin': 'DE',
        'Europe/Madrid': 'ES',
        'Europe/Amsterdam': 'NL',
        'Europe/Vienna': 'AT',
        'Europe/Zurich': 'CH',
        // UK/Ireland (BST/GMT)
        'Europe/London': 'GB',
        'Europe/Dublin': 'IE',
        // Americas (EST/EDT/PST/PDT)
        'America/New_York': 'US',
        'America/Los_Angeles': 'US',
        'America/Toronto': 'CA',
        'America/Mexico_City': 'MX',
        // Asia/Pacific
        'Asia/Kolkata': 'IN',
        'Australia/Sydney': 'AU',
        'Asia/Tokyo': 'JP',
        'Asia/Seoul': 'KR',
    };


    /**
     * Tenta di determinare il codice Paese (es. 'IT', 'US')
     * @returns {string} Codice Paese a due lettere o 'GB' come fallback.
     */
    function getCountryCodeFromLocaleOrTZ() {
        let countryCode = 'GB'; // Fallback predefinito

        try {
            const resolvedOptions = Intl.DateTimeFormat().resolvedOptions();

            // Tentativo 1 (PRIORITARIO): Ottiene il codice Paese dal locale risolto (es. 'it-IT' -> 'IT')
            const locale = resolvedOptions.locale; 
            const parts = locale.split('-');
            if (parts.length > 1 && parts[1].length === 2) {
                return parts[1].toUpperCase(); 
            }

            // Tentativo 2 (MIGLIORAMENTO): Mappatura IANA Time Zone ID (es. Europe/Rome -> IT)
            const timeZoneId = resolvedOptions.timeZone;
            if (IANA_TZ_TO_COUNTRY_MAP[timeZoneId]) {
                return IANA_TZ_TO_COUNTRY_MAP[timeZoneId];
            }

        } catch (e) {
            console.warn("Could not determine country code from locale or IANA Time Zone. Falling back to TZ acronym map.");
        }
        
        // Tentativo 3 (FALLBACK): Determina l'acronimo del fuso orario locale (meno preciso)
        try {
            const now = new Date();
            const localOptions = { timeZoneName: 'short' };
            // Usa 'en-US' per assicurare l'acronimo in formato standard
            const formattedLocalTime = now.toLocaleTimeString('en-US', localOptions); 
            
            const tzMatch = formattedLocalTime.match(/\b([A-Z]{3,5})\b/);
            const localTimeZoneAcronym = tzMatch ? tzMatch[1] : null;

            if (localTimeZoneAcronym && TZ_ACRONYM_MAP[localTimeZoneAcronym]) {
                return TZ_ACRONYM_MAP[localTimeZoneAcronym];
            }
        } catch (e) {
            console.error("Could not determine country code from Time Zone Acronym:", e);
        }

        // Fallback finale al Regno Unito (GB)
        return countryCode; 
    }

    /**
     * Converte un codice Paese ISO 3166-1 alpha-2 in un'emoji bandiera.
     * @param {string} countryCode - Codice Paese a due lettere (es. 'IT').
     * @returns {string} Emoji della bandiera.
     */
    function getEmojiFlag(countryCode) {
        if (!countryCode) return 'üåê'; // Globo come fallback
        const code = countryCode.toUpperCase();
        return String.fromCodePoint(
            ...code.split('').map(char => 127397 + char.charCodeAt())
        );
    }

    /**
     * Set the dynamic flag based on the user's location/TZ.
     */
    function setDynamicFlag() {
        const flagElement = document.getElementById('dynamic-flag-display');
        const userCountryCode = getCountryCodeFromLocaleOrTZ();
        const userFlag = getEmojiFlag(userCountryCode);
        flagElement.textContent = userFlag;
        flagElement.title = `La tua bandiera: ${userCountryCode}`;
    }
    
    // --------------------------------------------------------
    // LOGICHE DI RENDERING
    // --------------------------------------------------------

    // Helper function to convert 24-hour time to 12-hour AM/PM format (solo per l'orario UK di riferimento)
    function formatTime(hour, minute) {
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = (hour % 12) || 12; 
        const displayMinute = minute < 10 ? '0' + minute : minute;
        return `${displayHour}:${displayMinute} ${ampm}`;
    }

    // Map day numbers to English names
    const DAY_NAMES = [
        'Sunday', 'Monday', 'Tuesday', 'Wednesday', 
        'Thursday', 'Friday', 'Saturday'
    ];
    
    /**
     * Funzione ausiliaria per ottenere l'offset UTC in minuti (affidabile anche con DST).
     * CORREZIONE: Risolto RangeError non usando '12' come stringa di opzione.
     * @param {Date} date - Data di riferimento (per DST).
     * @param {string} timeZone - IANA Time Zone ID (es. 'Europe/London').
     * @returns {number} Offset del fuso orario rispetto a UTC in minuti (es. +60 per BST).
     */
    function getUTCOffsetMinutes(date, timeZone) {
        // Usiamo un punto di riferimento fisso (12:00 UTC) per determinare l'offset 
        // del fuso orario target (UK_TZ) rispetto a UTC in quel giorno specifico (gestendo DST).
        const utcDate = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0); 
        
        // 1. Convertiamo l'istante 12:00 UTC nell'ora corrispondente nel fuso orario UK.
        // Se UK √® GMT (UTC+0), l'ora sar√† 12. Se UK √® BST (UTC+1), l'ora sar√† 13.
        const hourInUK = new Date(utcDate).toLocaleString('en-US', {
            timeZone: timeZone, 
            hour: 'numeric', // Opzione corretta per l'ora
            hour12: false
        });
        
        // 2. L'offset √®: (Ora in UK - 12) * 60 minuti.
        const offsetHours = parseInt(hourInUK) - 12;
        
        return offsetHours * 60; // Restituisce +60 per BST (UTC+1), 0 per GMT (UTC+0).
    }


    /**
     * Converte l'orario UK (Europe/London) in orario locale per la visualizzazione.
     * @param {number} dayIndex - Giorno della settimana UK (0-6).
     * @param {number} hour - Ora UK (0-23).
     * @param {number} minute - Minuto UK (0-59).
     * @returns {{formattedTime: string, tzAcronym: string}} Ora locale formattata e acronimo del fuso orario.
     */
    function convertUKTimeToLocal(dayIndex, hour, minute) {
        const UK_TZ = 'Europe/London';
        const now = new Date();
        
        // 1. Determina il giorno di calendario per la prossima riunione
        const currentDayUK = new Date(now.toLocaleString('en-US', { timeZone: UK_TZ })).getDay();
        let daysToAdd = (dayIndex - currentDayUK + 7) % 7;
        
        // Se stesso giorno, verifica se l'orario √® gi√† passato
        if (daysToAdd === 0) {
            const ukTimeNow = new Date(now.toLocaleString('en-US', { timeZone: UK_TZ }));
            const scheduledUKMinutes = hour * 60 + minute;
            const currentUKMinutes = ukTimeNow.getHours() * 60 + ukTimeNow.getMinutes();
            if (currentUKMinutes >= scheduledUKMinutes) {
                 daysToAdd = 7;
            }
        }
        
        const targetDate = new Date();
        targetDate.setDate(now.getDate() + daysToAdd);
        
        // 2. Calcola l'offset UK per la data di riferimento.
        const targetDateForOffset = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate(), 12, 0, 0); 
        const ukOffsetMinutes = getUTCOffsetMinutes(targetDateForOffset, UK_TZ);

        // 3. Calcola il timestamp UTC per il momento desiderato in UK_TZ.
        
        // Timestamp di mezzanotte UTC del giorno target
        const targetDateUTC = new Date(Date.UTC(
            targetDate.getFullYear(), 
            targetDate.getMonth(), 
            targetDate.getDate(), 
            0, 0, 0 
        ));

        // Millisecondi totali per il momento desiderato (UK Time -> UTC)
        // [Ora UK] - [Offset UK da UTC] = [Ora UTC]
        const scheduledTimestampUTC = targetDateUTC.getTime() + 
                                      (hour * 60 * 60 * 1000) + 
                                      (minute * 60 * 1000) - 
                                      (ukOffsetMinutes * 60 * 1000);
        
        const scheduledTimeUTC = new Date(scheduledTimestampUTC);

        if (isNaN(scheduledTimeUTC.getTime())) {
             console.error("Failed to calculate UTC time for UK schedule.");
             return { formattedTime: 'Conversion Error', tzAcronym: 'ERR' };
        }
        
        // 4. Formatta l'orario UTC nel fuso orario locale dell'utente
        const localOptions = {
            weekday: 'short', 
            day: 'numeric', 
            month: 'short', 
            hour: '2-digit', 
            minute: '2-digit', 
            hour12: false, 
            timeZoneName: 'short'
        };
        
        const formattedLocalTimeFull = scheduledTimeUTC.toLocaleString(navigator.language, localOptions);

        // Estrae l'acronimo del fuso orario e l'ora formattata
        const tzMatch = formattedLocalTimeFull.match(/\b([A-Z]{3,5})\b/);
        const tzAcronym = tzMatch ? tzMatch[1] : 'Local Time'; 
        
        // Pulisce la stringa temporale dall'acronimo e dalla virgola (specifica di alcuni locali)
        let finalTime = formattedLocalTimeFull.replace(tzAcronym, '').trim(); 
        finalTime = finalTime.replace(/,\s*$/, '').trim(); 
        finalTime = finalTime.replace(/^,\s*/, '').trim();

        console.log(`[CONVERSIONE VERIFICATA] UK Time (${hour}:${minute}) -> Offset UK: ${ukOffsetMinutes} min. -> Ora Locale: ${finalTime} ${tzAcronym}`);

        return { formattedTime: finalTime, tzAcronym: tzAcronym };
    }
    
    // Function to group calls by day and render the UI
    function renderSchedule() {
        const container = document.getElementById('schedule-container');
        let htmlContent = '';
        let localTzAcronym = '';

        // 1. Group calls by day
        const callsByDay = SCHEDULE.reduce((acc, call) => {
            const dayName = DAY_NAMES[call.day];
            if (!acc[dayName]) {
                acc[dayName] = [];
            }
            acc[dayName].push(call);
            return acc;
        }, {});

        // 2. Iterate through all days (starting from Monday to Friday)
        const orderedDays = [1, 2, 3, 4, 5]; 

        orderedDays.forEach(dayIndex => {
            const dayName = DAY_NAMES[dayIndex];
            const calls = callsByDay[dayName];

            if (calls && calls.length > 0) {
                // Day Header
                htmlContent += `
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-lg">
                        <h2 class="text-2xl font-bold time-color mb-4 border-b pb-2">${dayName}</h2>
                        <div class="space-y-3">
                `;
                
                // Call Items
                calls.forEach(call => {
                    // Conversione dell'orario UK in orario locale
                    const localTimeData = convertUKTimeToLocal(call.day, call.startHour, call.startMinute);
                    const localFormattedTime = localTimeData.formattedTime;
                    localTzAcronym = localTimeData.tzAcronym; 
                    
                    // Ora UK per riferimento (es. 7:00 PM)
                    const ukTimeFormatted = formatTime(call.startHour, call.startMinute);

                    htmlContent += `
                        <a href="${call.link}" target="_blank" class="schedule-item bg-gray-50 hover:bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <!-- Icon -->
                            <svg class="w-6 h-6 text-gray-400 mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            
                            <!-- Content -->
                            <div class="text-left flex-grow">
                                <p class="text-lg font-semibold text-gray-800">${call.description} (${ukTimeFormatted} UK Time)</p>
                                <p class="text-md time-color font-bold">
                                    ${localFormattedTime} 
                                    <span class="text-gray-500 font-normal text-sm">(${localTzAcronym}, Join via Zoom)</span>
                                </p>
                            </div>
                            
                            <!-- Arrow -->
                            <svg class="w-5 h-5 text-gray-400 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                    `;
                });

                htmlContent += `
                        </div>
                    </div>
                `;
            }
        });
        
        // Aggiunge l'acronimo del fuso orario locale all'intestazione, se disponibile
        if (localTzAcronym) {
            // Rimuove eventuali messaggi precedenti per evitare duplicati
            const existingTZMessage = document.getElementById('tz-message');
            if (existingTZMessage) existingTZMessage.remove();

            document.querySelector('.schedule-card h1').insertAdjacentHTML('afterend', 
                `<p id="tz-message" class="text-md text-gray-600 mb-6">All times displayed below are converted to your local time zone: <strong class="time-color">${localTzAcronym}</strong></p>`
            );
        }

        container.innerHTML = htmlContent;
    }

    // Start the rendering and flag setup
    document.addEventListener('DOMContentLoaded', () => {
        setDynamicFlag();
        renderSchedule();
    });
</script>

</body>
</html>
